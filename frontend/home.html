<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Central de Suporte</title>
    <!-- O seu CSS base para fontes e cores primárias -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/jpeg" href="css/Imagens/icone_sistema.jpg">
    <link rel="icon" href="data:,">
    <style>
        /* ======================================================================== */
        /* ESTILOS CSS - VERSÃO HÍBRIDA DO DASHBOARD                                */
        /* ======================================================================== */

        body {
            background-color: #f0f2f5;
            display: flex;
            min-height: 100vh;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dashboard-container {
            display: flex;
            width: 100%;
        }

        /* --- Barra Lateral (Sidebar) --- */
        .sidebar {
            width: 250px;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar .logo {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .sidebar nav {
            flex-grow: 1;
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            text-decoration: none;
            color: #555;
            font-weight: 500;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar nav a svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .sidebar nav a:hover, .sidebar nav a.active {
            background-color: #74ebd5; /* Cor primária do seu sistema */
            color: #fff;
        }

        .sidebar .logout-button {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            background-color: #fdecec;
            color: #e53e3e;
            font-weight: bold;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }

        /* --- Conteúdo Principal --- */
        .main-content {
            flex-grow: 1;
            padding: 30px 40px;
            overflow-y: auto;
            transition: background 0.5s ease;
        }
        
        /* Estilo dinâmico para o fundo do Dashboard */
        .main-content.dashboard-view {
            background: linear-gradient(135deg, #74ebd5, #9face6);
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .main-header h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #333;
            transition: color 0.5s ease;
        }
        
        /* Estilo dinâmico para o título do Dashboard */
        .main-content.dashboard-view .main-header h1,
        .main-content.dashboard-view .user-profile span {
            color: white;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
        }
        .user-profile span {
            margin-right: 15px;
            font-weight: 500;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #9face6;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .main-content.dashboard-view .user-avatar {
             background-color: rgba(255, 255, 255, 0.3);
        }

        /* --- Estilos para os Widgets (como na foto) --- */
        .widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }
        .widget {
            background: rgba(255, 255, 255, 0.85);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .widget h3 { font-size: 1em; color: #555; margin-bottom: 10px; }
        .widget .value { font-size: 2.2em; font-weight: 700; color: #333; }
        
        /* Painel para a tabela e outras páginas */
        .content-panel {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        /* Painel semi-transparente para o dashboard */
        .main-content.dashboard-view .content-panel {
             margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .content-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .content-panel h2 {
           margin: 0; padding: 0; border: none; color: #333;
        }
        
        /* Barra de Filtros */
        .filter-bar { display: flex; gap: 20px; margin-bottom: 25px; align-items: flex-end; }
        .search-bar { flex-grow: 1; min-width: 250px; }
        .search-bar input, .filter-group select, .form-group select, .form-group input, .form-group textarea {
            width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;
        }
        .filter-group, .form-group { display: flex; flex-direction: column; }
        .filter-group label, .form-group label { font-size: 0.8em; margin-bottom: 5px; color: #666; }
        
        /* Tabela de Chamados */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        .data-table th { background-color: #f9f9f9; }
        .data-table tbody tr.clickable { cursor: pointer; transition: background-color 0.2s ease; }
        .data-table tbody tr.clickable:hover { background-color: #f9f9f9; }
        
        /* Estilos para badges de status */
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: #fff; }
        .status-aberto { background-color: #3b82f6; }
        .status-em-andamento { background-color: #f97316; }
        .status-resolvido { background-color: #16a34a; }

        /* Formulários */
        .ticket-form, .ticket-detail-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 30px;
        }
        .full-width { grid-column: 1 / -1; }
        .half-width { grid-column: span 2; }
        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 10px;
        }
        .secondary-button { background-color: #e2e8f0; color: #475569; }
        .secondary-button:hover { background-color: #cbd5e1; }
        
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Barra Lateral de Navegação (Menu) -->
        <aside class="sidebar">
            <div class="logo">HelpDesk</div>
            <nav>
                <ul>
                    <!-- Ícones SVG omitidos para brevidade -->
                    <li><a href="#" class="nav-link active" data-page="dashboard">Dashboard</a></li>
                    <li><a href="#" class="nav-link" data-page="todos_chamados">Todos os Chamados</a></li>
                    <li><a href="#" class="nav-link" data-page="meus_chamados">Meus Chamados</a></li>
                    <li><a href="#" class="nav-link" data-page="abrir_chamado">Abrir Chamado</a></li>
                </ul>
            </nav>
            <a href="index.html" class="logout-button">Sair</a>
        </aside>

        <!-- Área de Conteúdo Principal -->
        <main class="main-content" id="main-content-area">
            <header class="main-header">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-profile">
                    <span>Bem-vindo, Luiz!</span>
                    <div class="user-avatar">LP</div>
                </div>
            </header>

            <div id="page-content">
                <!-- Conteúdo dinâmico será injetado aqui -->
            </div>
        </main>
    </div>
<script>
    //<!-- SCRIPT CORRIGIDO E RESTAURADO --> 
    document.addEventListener('DOMContentLoaded', () => {
    // --- 1. SELEÇÃO DOS ELEMENTOS PRINCIPAIS ---
    const navLinks = document.querySelectorAll('.nav-link');
    const pageTitle = document.getElementById('page-title');
    const pageContent = document.getElementById('page-content');
    const mainContentArea = document.getElementById('main-content-area');
    const currentUser = 'Luiz Panis';

    // --- 2. ESTADO DA APLICAÇÃO ---
    // A nossa "base de dados" local. Começa vazia e será preenchida pela API.
    let ticketData = [];
    let technicians = [];

    // --- 3. FUNÇÕES DE COMUNICAÇÃO COM O BACKEND (API) ---

    // Função para buscar todos os chamados do servidor
    async function fetchTickets() {
        try {
            const response = await fetch('http://localhost:3000/chamados');
            if (!response.ok) throw new Error('Falha na resposta da rede');
            ticketData = await response.json();
            // Atualiza a lista de técnicos dinamicamente a partir dos dados recebidos
            technicians = ['Todos', ...new Set(ticketData.filter(t => t.assignee).map(t => t.assignee))];
        } catch (error) {
            console.error("Erro ao buscar chamados da API:", error);
            alert("Não foi possível carregar os chamados do servidor.");
        }
    }

    // Função para criar um novo chamado no servidor
    async function createTicket(newTicket) {
        try {
            const response = await fetch('http://localhost:3000/chamados', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newTicket)
            });
            if (!response.ok) throw new Error('Falha ao criar chamado');
            alert('Novo chamado aberto com sucesso!');
            await fetchTickets(); // Atualiza a lista de chamados local
            loadPage('todos_chamados');
        } catch (error) {
            console.error("Erro ao criar chamado:", error);
            alert("Não foi possível criar o chamado no servidor.");
        }
    }

    // Função para atualizar um chamado existente no servidor
    async function updateTicket(ticketId, updatedData) {
        try {
            const response = await fetch(`http://localhost:3000/chamados/${ticketId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            if (!response.ok) throw new Error('Falha ao atualizar chamado');
            return await response.json();
        } catch (error) {
            console.error(`Erro ao atualizar chamado #${ticketId}:`, error);
            alert("Não foi possível salvar as alterações no servidor.");
        }
    }

    // --- 4. "TEMPLATES" DAS PÁGINAS ---
    // Esta função gera o HTML para cada página dinamicamente, usando os dados mais recentes.
    function getPageTemplates() {
        const statuses = ['Todos', 'Aberto', 'Em Andamento', 'Resolvido'];
        return {
            dashboard: `
                <div class="widgets-grid">
                    <div class="widget"><h3>Chamados Abertos</h3><p class="value">${ticketData.filter(t => t.status === 'Aberto').length}</p></div>
                    <div class="widget"><h3>Meus Chamados Ativos</h3><p class="value">${ticketData.filter(t => t.assignee === currentUser && t.status !== 'Resolvido').length}</p></div>
                    <div class="widget"><h3>Prioridade Alta</h3><p class="value">${ticketData.filter(t => t.priority === 'Alta' && t.status !== 'Resolvido').length}</p></div>
                </div>
                <div class="content-panel">
                    <h2>Chamados de Alta Prioridade Abertos</h2>
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>Título</th><th>Solicitante</th><th>Técnico</th><th>Andamento</th></tr></thead>
                        <tbody id="dashboard-urgent-tickets"></tbody>
                    </table>
                </div>
            `,
            todos_chamados: `
                <div class="content-panel">
                    <h2>Todos os Chamados</h2>
                    <div class="filter-bar">
                        <div class="search-bar"><input type="text" id="search-input" placeholder="Pesquisar por ID ou título..."></div>
                        <div class="filter-group"><label for="status-filter">Situação</label><select id="status-filter">${statuses.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                        <div class="filter-group"><label for="technician-filter">Técnico</label><select id="technician-filter">${technicians.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>Título</th><th>Status</th><th>Prioridade</th><th>Técnico</th><th>Andamento (%)</th></tr></thead>
                        <tbody id="all-tickets-table-body"></tbody>
                    </table>
                </div>
            `,
            meus_chamados: `
                <div class="content-panel">
                     <h2>Meus Chamados</h2>
                    <table class="data-table">
                         <thead><tr><th>ID</th><th>Título</th><th>Status</th><th>Prioridade</th><th>Solicitante</th><th>Andamento (%)</th></tr></thead>
                         <tbody id="my-tickets-table-body"></tbody>
                    </table>
                </div>
            `,
            abrir_chamado: `
                 <div class="content-panel">
                    <h2>Abrir Novo Chamado</h2>
                    <form class="ticket-form" id="new-ticket-form">
                        <div class="form-group half-width"><label>Grupos:</label><input type="text" value="NTI - Núcleo de tecnologia da informação" disabled style="background:#eee;"></div>
                        <div class="form-group half-width"><label>Área:</label><input type="text" value="Suporte ao Usuário" disabled style="background:#eee;"></div>
                        <div class="form-group half-width"><label for="ticket-requester">Nome:</label><input type="text" id="ticket-requester" value="${currentUser}" required></div>
                        <div class="form-group half-width"><label for="ticket-email">E-mail:</label><input type="email" id="ticket-email" value="luiz.panis@email.com" required></div>
                        <div class="form-group"><label for="sala">Sala:</label><input type="text" id="sala"></div>
                        <div class="form-group"><label for="predio">Prédio:</label><input type="text" id="predio"></div>
                        <div class="form-group half-width"><label for="telefone">Telefone:</label><input type="tel" id="telefone"></div>
                        <div class="form-group full-width"><label for="ticket-title">Título:</label><input type="text" id="ticket-title" placeholder="Digite uma descrição detalhada do chamado" required></div>
                        <div class="form-group full-width"><label for="ticket-description">Descrição:</label><textarea id="ticket-description" placeholder="Detalhe o seu problema ou solicitação..." required style="min-height: 150px; resize: vertical;"></textarea></div>
                        <div class="form-group half-width"><label for="ticket-priority">Prioridade:</label><select id="ticket-priority"><option value="">-- Selecione --</option><option>Baixa</option><option>Média</option><option>Alta</option></select></div>
                        <div class="form-group half-width"><label for="ticket-patrimonio">Número de patrimônio:</label><input type="text" id="ticket-patrimonio"></div>
                        <div class="form-actions full-width">
                            <button type="button" class="action-button secondary-button" id="cancel-btn">Cancelar</button>
                            <button type="submit" class="action-button">Finalizar Chamado</button>
                        </div>
                    </form>
                </div>
            `,
        };
    }

    // --- 5. FUNÇÕES DE RENDERIZAÇÃO E LÓGICA DE EVENTOS ---
    
    function renderUrgentTickets() { /* ... (sem alterações) */ }
    function renderAllTickets() { /* ... (sem alterações) */ }
    function renderMyTickets() { /* ... (sem alterações) */ }

    function renderTable(tbody, data, isMyTicketsTable = false) {
        if (!tbody) return;
        tbody.innerHTML = data.length > 0 ? data.map(ticket => `
            <tr data-ticket-id="${ticket.id}" class="clickable">
                <td>#${ticket.id}</td>
                <td>${ticket.title}</td>
                <td><span class="status-badge status-${ticket.status.toLowerCase().replace(/ /g, '-')}">${ticket.status}</span></td>
                <td>${ticket.priority}</td>
                <td>${isMyTicketsTable ? ticket.requester : (ticket.assignee || 'Não atribuído')}</td>
                <td>${ticket.progress}%</td>
            </tr>
        `).join('') : `<tr><td colspan="6" style="text-align:center;">Nenhum chamado encontrado.</td></tr>`;

        tbody.querySelectorAll('tr.clickable').forEach(row => {
            row.addEventListener('click', () => {
                const ticketId = row.dataset.ticketId;
                const previousPage = tbody.id.includes('my-tickets') ? 'meus_chamados' : (tbody.id.includes('all-tickets') ? 'todos_chamados' : 'dashboard');
                if (ticketId) loadTicketDetail(parseInt(ticketId), previousPage);
            });
        });
    }

    function loadTicketDetail(ticketId, previousPage) {
        const ticket = ticketData.find(t => t.id === ticketId);
        pageTitle.textContent = `Detalhe do Chamado #${ticket.id}`;
        mainContentArea.classList.remove('dashboard-view');
        
        pageContent.innerHTML = `
            <div class="content-panel">
                <h2>${ticket.title}</h2>
                <form class="ticket-detail-form" id="ticket-detail-form">
                    <fieldset class="full-width" style="border:1px solid #eee; padding:15px; border-radius:8px;">
                        <legend style="padding:0 10px; font-weight:bold;">Detalhes do Chamado</legend>
                        <div class="ticket-form">
                            <div class="form-group half-width"><label>Solicitante:</label><input type="text" value="${ticket.requester}" disabled style="background:#eee;"></div>
                            <div class="form-group half-width"><label>Email:</label><input type="text" value="${ticket.email || 'N/A'}" disabled style="background:#eee;"></div>
                            <div class="form-group"><label>Sala:</label><input type="text" value="${ticket.sala || 'N/A'}" disabled style="background:#eee;"></div>
                            <div class="form-group"><label>Prédio:</label><input type="text" value="${ticket.predio || 'N/A'}" disabled style="background:#eee;"></div>
                            <div class="form-group half-width"><label>Telefone:</label><input type="text" value="${ticket.telefone || 'N/A'}" disabled style="background:#eee;"></div>
                            <div class="form-group half-width"><label>Nº Patrimônio:</label><input type="text" value="${ticket.patrimonio || 'N/A'}" disabled style="background:#eee;"></div>
                            <div class="form-group full-width"><label>Descrição Original:</label><textarea disabled style="background:#eee; min-height:100px; resize:none;">${ticket.description}</textarea></div>
                        </div>
                    </fieldset>
                    <fieldset class="full-width" style="border:1px solid #eee; padding:15px; border-radius:8px; margin-top:20px;">
                        <legend style="padding:0 10px; font-weight:bold;">Atendimento do Técnico</legend>
                        <div class="ticket-form">
                            <div class="form-group"><label>Atribuído para:</label><select id="assignee-select">${technicians.filter(t => t !== 'Todos').map(t => `<option ${ticket.assignee === t ? 'selected' : ''}>${t}</option>`).join('')}<option ${!ticket.assignee ? 'selected' : ''}>Não atribuído</option></select></div>
                            <div class="form-group"><label>Situação:</label><select id="status-select"><option ${ticket.status === 'Aberto' ? 'selected' : ''}>Aberto</option><option ${ticket.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option><option ${ticket.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option></select></div>
                            <div class="form-group"><label>Situação do andamento:</label><select id="situation-select"><option ${ticket.situation === 'Aguardando Atendimento' ? 'selected' : ''}>Aguardando Atendimento</option><option ${ticket.situation === 'Analisando o Problema' ? 'selected' : ''}>Analisando o Problema</option><option ${ticket.situation === 'Finalizado' ? 'selected' : ''}>Finalizado</option></select></div>
                            <div class="form-group"><label>Andamento (%):</label><select id="progress-select"><option value="0" ${ticket.progress === 0 ? 'selected' : ''}>0%</option><option value="20" ${ticket.progress === 20 ? 'selected' : ''}>20%</option><option value="50" ${ticket.progress === 50 ? 'selected' : ''}>50%</option><option value="100" ${ticket.progress === 100 ? 'selected' : ''}>100%</option></select></div>
                            <div class="form-group full-width"><label>Anotações da Solução:</label><textarea id="solution-notes" placeholder="Descreva a solução aplicada...">${ticket.solution_notes || ''}</textarea></div>
                        </div>
                    </fieldset>
                    <div class="form-actions full-width">
                        <button type="button" class="action-button secondary-button" id="back-to-list-btn">Voltar</button>
                        <button type="submit" class="action-button">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        `;

        document.getElementById('back-to-list-btn').addEventListener('click', () => loadPage(previousPage));
        document.getElementById('ticket-detail-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedData = {
                status: document.getElementById('status-select').value,
                situation: document.getElementById('situation-select').value,
                progress: parseInt(document.getElementById('progress-select').value),
                assignee: document.getElementById('assignee-select').value,
                solution_notes: document.getElementById('solution-notes').value,
            };
            const updatedTicket = await updateTicket(ticketId, updatedData);
            if (updatedTicket) {
                alert(`Alterações ao chamado #${ticketId} salvas com sucesso!`);
                await fetchTickets();
                loadPage(previousPage);
            }
        });
    }

    function setupEventListeners(pageName) {
        if (pageName === 'dashboard') {
            renderUrgentTickets();
        } else if (pageName === 'todos_chamados') {
            document.getElementById('search-input').addEventListener('input', renderAllTickets);
            document.getElementById('status-filter').addEventListener('change', renderAllTickets);
            document.getElementById('technician-filter').addEventListener('change', renderAllTickets);
            renderAllTickets();
        } else if (pageName === 'meus_chamados') {
            renderMyTickets();
        } else if (pageName === 'abrir_chamado') {
            document.getElementById('new-ticket-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newTicket = {
                    title: document.getElementById('ticket-title').value,
                    requester: document.getElementById('ticket-requester').value,
                    email: document.getElementById('ticket-email').value,
                    sala: document.getElementById('sala').value,
                    predio: document.getElementById('predio').value,
                    telefone: document.getElementById('telefone').value,
                    description: document.getElementById('ticket-description').value,
                    priority: document.getElementById('ticket-priority').value,
                    patrimonio: document.getElementById('ticket-patrimonio').value,
                };
                createTicket(newTicket);
            });
            document.getElementById('cancel-btn').addEventListener('click', () => loadPage('todos_chamados'));
        }
    }
    
    async function loadPage(pageName) {
        const linkText = document.querySelector(`.nav-link[data-page="${pageName}"]`).textContent.trim();
        pageTitle.textContent = linkText;
        pageContent.innerHTML = getPageTemplates()[pageName] || '<p>Página não encontrada.</p>';

        mainContentArea.classList.toggle('dashboard-view', pageName === 'dashboard');
        navLinks.forEach(link => link.classList.toggle('active', link.dataset.page === pageName));
        
        setupEventListeners(pageName);
    }

    async function initializeApp() {
        await fetchTickets();
        loadPage('dashboard');
    }

    initializeApp();

    navLinks.forEach(link => {
        link.addEventListener('click', async (event) => {
            event.preventDefault();
            const page = event.target.closest('a').dataset.page;
            await fetchTickets();
            loadPage(page);
        });
    });
});
</script>
</body>
</html>


